#!/usr/bin/env node
const fs = require("fs");
const path = require("path");
const { exec } = require("child_process");
const readline = require("readline");
const { createClient } = require("@supabase/supabase-js");

const command = process.argv[2];
const pkgName = process.argv[3];

if (["pub", "publish", "Ù†Ø´Ø±"].includes(command)) {
  pubLib();
} else if (["get", "install", "i", "ØªØ­Ù…ÙŠÙ„"].includes(command)) {
  getLib();
} else if (["version", "v", "Ø§ØµØ¯Ø§Ø±"].includes(command)) {
  console.log("0.1.0 Ø§ØµØ¯Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª");
} else if (["update", "ØªØ­Ø¯ÙŠØ«"].includes(command)) {
  if (pkgName) {
    getLib();
  } else {
    // ØªØ­Ø¯ÙŠØ« Ù„ØºØ© Ø§Ù„Ù
  }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† git
function checkGit() {
  exec("git --version", (error, stdout, stderr) => {
    if (error || stderr) {
      console.log(" Git ØºÙŠØ± Ù…Ø«Ø¨ØªØŒ Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØªÙ‡...");

      let installCommand = "";
      if (process.platform === "win32") {
        installCommand = "winget install --id Git.Git -e --source winget"; // ÙˆÙŠÙ†Ø¯ÙˆØ²
      } else if (process.platform === "darwin") {
        installCommand = "brew install git"; // Ù…Ø§Ùƒ
      } else if (process.platform === "linux") {
        exec("cat /etc/os-release", (osError, osStdout, osStderr) => {
          if (osError || osStderr) {
            console.error("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙŠØ±Ø¬ÙŠ ØªØ«Ø¨ÙŠØª git.");
            process.exit(1);
          }

          if (osStdout.includes("ubuntu") || osStdout.includes("debian")) {
            installCommand = "sudo apt install git";
          } else if (
            osStdout.includes("fedora") ||
            osStdout.includes("centos")
          ) {
            installCommand = "sudo dnf install git";
          }

          if (installCommand) {
            console.log(`Ø³ÙŠØªÙ… ØªØ«Ø¨ÙŠØª git Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${installCommand}`);
            exec(
              installCommand,
              (installError, installStdout, installStderr) => {
                if (installError || installStderr) {
                  console.error(
                    "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ«Ø¨ÙŠØª Git:",
                    installError || installStderr
                  );
                  process.exit(1);
                }
                console.log("ØªÙ… ØªØ«Ø¨ÙŠØª Git Ø¨Ù†Ø¬Ø§Ø­!");
              }
            );
          }
        });
      }

      if (installCommand) {
        console.log(`ðŸš€ Ø³ÙŠØªÙ… ØªØ«Ø¨ÙŠØª git Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${installCommand}`);
        exec(installCommand, (installError, installStdout, installStderr) => {
          if (installError || installStderr) {
            console.error(
              " Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ«Ø¨ÙŠØª Git:",
              installError || installStderr
            );
            process.exit(1);
          }
          console.log(`${installStdout} ØªÙ… ØªØ«Ø¨ÙŠØª Git Ø¨Ù†Ø¬Ø§Ø­!`);
        });
      }
    } else {
      // console.log(` Git Ø§ØµØ¯Ø§Ø±: ${stdout}`);
    }
  });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø±
function pubLib() {
  const packageDir = pkgName;
  checkGit();

  if (!packageDir) {
    console.error("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø©");
    process.exit(1);
  }

  const pkgPath = path.join(process.cwd(), "Ù…ÙƒØªØ¨Ø©.Ø§Ù„Ù");
  if (!fs.existsSync(pkgPath)) {
    console.error('Ù…Ù„Ù "Ù…ÙƒØªØ¨Ø©.Ø§Ù„Ù" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯');
    process.exit(1);
  }

  const data = JSON.parse(fs.readFileSync(pkgPath, "utf-8"));
  const requiredFields = [
    "Ø§Ù„Ø§Ø³Ù…",
    "Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹",
    "Ø§Ù„Ø§ØµØ¯Ø§Ø±",
    "Ø§Ù„ÙˆØµÙ",
    "Ø§Ù„ØµÙˆØ±Ø©",
    "Ø§Ù„Ù…Ø·ÙˆØ±",
    "Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…Ø·ÙˆØ±",
  ];
  requiredFields.forEach((field) => {
    if (!Object.keys(data).includes(field)) {
      console.error(`Ø§Ù„Ø­Ù‚Ù„ "${field}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ù„Ù Ù…ÙƒØªØ¨Ø©.Ø§Ù„Ù`);
      process.exit(1);
    }
  });
  // if (data["Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹"] !== pkgName) {
  //   console.error(
  //     `Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙŠØ¬Ø¨ Ø§Ù† ÙŠÙƒÙˆÙ† Ù…Ø³Ø§ÙˆÙŠ Ù„Ù€"Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹" ÙÙŠ Ù…Ù„Ù "Ù…ÙƒØªØ¨Ø©.Ø§Ù„Ù"`
  //   );
  //   process.exit(1);
  // }

  if (!fs.existsSync(path.join(process.cwd(), ".git"))) {
    exec(
      `echo "# ${pkgName}" >> README.md &&
      git init &&
      git add . &&
      git commit -m "Ø§ÙˆÙ„ Ø§ØµØ¯Ø§Ø±" &&
      git branch -M main`,
      (error, stdout, stderr) => {
        if (error || stderr) {
          console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ :", error || stderr);
          process.exit(1);
        }
        console.log("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù…Ø­Ù„ÙŠØ§!");
      }
    );
  } else {
    console.log("Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.");
  }

  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  rl.question("Ù‡Ù„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙˆØ¯Ø¹ Ø¹Ù„Ù‰ GitHubØŸ (Ù†Ø¹Ù…/Ù„Ø§): ", (answer) => {
    if (answer === "Ù†Ø¹Ù…" || answer === "y") {
      exec(
        `git remote add origin https://github.com/${data.Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…Ø·ÙˆØ±}/${pkgName}.git &&
        git push -u origin main`,
        (error, stdout, stderr) => {
          if (error || stderr) {
            console.error(
              "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª:",
              error || stderr
            );
            process.exit(1);
          }
          console.log("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        }
      );
    } else if (answer === "Ù„Ø§" || answer === "n") {
      console.log("ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙˆØ¯Ø¹ Ø¹Ù„Ù‰ GitHub Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
    } else {
      console.error("Ø±Ø¯ Ø¨ Ù†Ø¹Ù… Ø§Ùˆ Ù„Ø§");
    }
    rl.close();
  });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
function getLib() {
  async function install(pkgname) {
    try {
      const appDir = path.join(__dirname, "libraries", pkgname);

      await new Promise((resolve, reject) => {
        const supabaseUrl = "https://gfyxjkwchsnczsmthpiw.supabase.co";
        const supabaseKey =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmeXhqa3djaHNuY3pzbXRocGl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyODUyODUsImV4cCI6MjA1OTg2MTI4NX0.b40Gi7Jsk_XkJSW-W5OU8oXyQZMHLUfqVw0R09Njyj4";
        const supabase = createClient(supabaseUrl, supabaseKey);

        supabase
          .from("libraries")
          .select("*")
          .eq("Ø§Ù„Ø§Ø³Ù…", pkgname)
          .then(({ data, error }) => {
            if (error || !data || data.length === 0) {
              reject(`Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø© "${pkgname}"`);
            } else {
              const developer = data[0].Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…Ø·ÙˆØ±;
              const repoName = data[0].Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹;
              // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù…Ù† Ø§Ù„Ø¬ÙŠØª Ù‡Ø§Ø¨
              exec(`npx degit ${developer}/${repoName} ${appDir}`, (err) => {
                if (err) {
                  if (
                    String(err).includes("destination directory is not empty")
                  ) {
                    reject(`"Ø§Ù„Ù…ÙƒØªØ¨Ø© "${pkgname}"  Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„`);
                  } else {
                    reject(
                      `Ø­Ø¯Ø« Ø®Ø·Ø£: "${err}"`
                    );
                  }
                } else {
                  //  Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª
                  const downloads = data[0].Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª + 1;
                  supabase
                    .from("libraries")
                    .update({ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: downloads })
                    .eq("Ø§Ù„Ø§Ø³Ù…", pkgname)
                    .then(({ error }) => {
                      if (error) {
                        console.error(
                          "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª:",
                          error
                        );
                      }
                    });
                  console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­!");
                  resolve();
                }
              });
            }
          });
      });
    } catch (error) {
      console.error(error);
    }
  }

  if (!pkgName) {
    console.error("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© ØµØ­");
  } else {
    install(pkgName);
  }
}
