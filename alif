#!/usr/bin/env node
const fs = require("fs");
const path = require("path");
const { exec } = require("child_process");
const readline = require("readline");
const { createClient } = require("@supabase/supabase-js");

const supabaseUrl = "https://gfyxjkwchsnczsmthpiw.supabase.co";
const supabaseKey =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmeXhqa3djaHNuY3pzbXRocGl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyODUyODUsImV4cCI6MjA1OTg2MTI4NX0.b40Gi7Jsk_XkJSW-W5OU8oXyQZMHLUfqVw0R09Njyj4";
const supabase = createClient(supabaseUrl, supabaseKey);

const command = process.argv[2];
const pkgName = process.argv[3];

if (["pub", "publish", "Ù†Ø´Ø±"].includes(command)) {
  pubLib();
} else if (["get", "install", "i", "ØªØ­Ù…ÙŠÙ„"].includes(command)) {
  getLib();
} else if (["version", "v", "Ø§ØµØ¯Ø§Ø±"].includes(command)) {
  console.log("0.1.0 Ø§ØµØ¯Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª");
} else if (["update", "ØªØ­Ø¯ÙŠØ«"].includes(command)) {
  if (pkgName) {
    getLib();
  } else {
    // ØªØ­Ø¯ÙŠØ« Ù„ØºØ© Ø§Ù„Ù
  }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† git
function checkGit() {
  exec("git --version", (error, stdout, stderr) => {
    if (error || stderr) {
      console.log(" Git ØºÙŠØ± Ù…Ø«Ø¨ØªØŒ Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØªÙ‡...");

      let installCommand = "";
      if (process.platform === "win32") {
        installCommand = "winget install --id Git.Git -e --source winget"; // ÙˆÙŠÙ†Ø¯ÙˆØ²
      } else if (process.platform === "darwin") {
        installCommand = "brew install git"; // Ù…Ø§Ùƒ
      } else if (process.platform === "linux") {
        exec("cat /etc/os-release", (osError, osStdout, osStderr) => {
          if (osError || osStderr) {
            console.error("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙŠØ±Ø¬ÙŠ ØªØ«Ø¨ÙŠØª git.");
            process.exit(1);
          }

          if (osStdout.includes("ubuntu") || osStdout.includes("debian")) {
            installCommand = "sudo apt install git";
          } else if (
            osStdout.includes("fedora") ||
            osStdout.includes("centos")
          ) {
            installCommand = "sudo dnf install git";
          }

          if (installCommand) {
            console.log(`Ø³ÙŠØªÙ… ØªØ«Ø¨ÙŠØª git Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${installCommand}`);
            exec(
              installCommand,
              (installError, installStdout, installStderr) => {
                if (installError || installStderr) {
                  console.error(
                    "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ«Ø¨ÙŠØª Git:",
                    installError || installStderr
                  );
                  process.exit(1);
                }
                console.log("ØªÙ… ØªØ«Ø¨ÙŠØª Git Ø¨Ù†Ø¬Ø§Ø­!");
              }
            );
          }
        });
      }

      if (installCommand) {
        console.log(`ðŸš€ Ø³ÙŠØªÙ… ØªØ«Ø¨ÙŠØª git Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${installCommand}`);
        exec(installCommand, (installError, installStdout, installStderr) => {
          if (installError || installStderr) {
            console.error(
              " Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ«Ø¨ÙŠØª Git:",
              installError || installStderr
            );
            process.exit(1);
          }
          console.log(`${installStdout} ØªÙ… ØªØ«Ø¨ÙŠØª Git Ø¨Ù†Ø¬Ø§Ø­!`);
        });
      }
    } else {
      // console.log(` Git Ø§ØµØ¯Ø§Ø±: ${stdout}`);
    }
  });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø±
function pubLib() {
  checkGit();

  if (!pkgName) {
    console.error("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø©");
    process.exit(1);
  }

  const pkgPath = path.join(process.cwd(), "Ù…ÙƒØªØ¨Ø©.Ø§Ù„Ù");
  if (!fs.existsSync(pkgPath)) {
    console.error('Ù…Ù„Ù "Ù…ÙƒØªØ¨Ø©.Ø§Ù„Ù" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯');
    process.exit(1);
  }

  const data = JSON.parse(fs.readFileSync(pkgPath, "utf-8"));
  const requiredFields = [
    "Ø§Ù„Ø§Ø³Ù…",
    "Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹",
    "Ø§Ù„Ø§ØµØ¯Ø§Ø±",
    "Ø§Ù„ÙˆØµÙ",
    "Ø§Ù„ØµÙˆØ±Ø©",
    "Ø§Ù„Ù…Ø·ÙˆØ±",
    "Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…Ø·ÙˆØ±",
  ];
  requiredFields.forEach((field) => {
    if (!Object.keys(data).includes(field)) {
      console.error(`Ø§Ù„Ø­Ù‚Ù„ "${field}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ù„Ù Ù…ÙƒØªØ¨Ø©.Ø§Ù„Ù`);
      process.exit(1);
    }
  });
  if (data["Ø§Ù„Ø§Ø³Ù…"].replaceAll(" ", "_") !== pkgName) {
    console.error(
      `Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© "${pkgName}" Ù„Ø§ÙƒÙ† Ø¨Ø¯Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© "_" ÙŠØ¬Ø¨ Ø§Ù† ÙŠÙƒÙˆÙ† Ù…Ø³Ø§ÙˆÙŠ Ù„Ù€"Ø§Ù„Ø§Ø³Ù…" ÙÙŠ Ù…Ù„Ù "Ù…ÙƒØªØ¨Ø©.Ø§Ù„Ù"`
    );
    process.exit(1);
  }

  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  rl.question(
    "Ù‡Ù„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙˆØ¯Ø¹ Ø¹Ù„Ù‰ GitHub ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§ØªØŸ (Ù†Ø¹Ù…/Ù„Ø§): ",
    (answer) => {
      if (answer === "Ù†Ø¹Ù…" || answer === "y") {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¹Ù„Ù‰ GitHub
        const repoUrl = `https://github.com/${data["Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…Ø·ÙˆØ±"]}/${data["Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹"]}`;
        exec(`git ls-remote ${repoUrl}`, (gitError, stdout, stderr) => {
          if (gitError || stderr) {
            console.error(
              `ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¹Ù„Ù‰ GitHub: ${repoUrl}. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.`
            );
            process.exit(1);
          } else {
            console.log("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¹Ù„Ù‰ GitHub Ø¨Ù†Ø¬Ø§Ø­.");
            // Ø±ÙØ¹ Ø§Ù„ÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const finalData = {
              Ø§Ù„Ø§Ø³Ù…: data["Ø§Ù„Ø§Ø³Ù…"].replaceAll(" ", "_"),
              Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: data["Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹"],
              Ø§Ù„Ø§ØµØ¯Ø§Ø±: data["Ø§Ù„Ø§ØµØ¯Ø§Ø±"],
              Ø§Ù„ÙˆØµÙ: data["Ø§Ù„ÙˆØµÙ"],
              Ø§Ù„ØµÙˆØ±Ø©: data["Ø§Ù„ØµÙˆØ±Ø©"],
              Ø§Ù„Ù…Ø·ÙˆØ±: data["Ø§Ù„Ù…Ø·ÙˆØ±"],
              Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…Ø·ÙˆØ±: data["Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…Ø·ÙˆØ±"],
              Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: `https://github.com/${data["Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…Ø·ÙˆØ±"]}/${data["Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹"]}/`,
              Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: 0,
            };

            supabase
              .from("libraries")
              .insert(finalData)
              .then(({ error }) => {
                if (error) {
                  if (
                    error.message.includes("duplicate key") &&
                    error.message.includes("Ø§Ù„Ø§Ø³Ù…")
                  ) {
                    console.error("ÙŠÙˆØ¬Ø¯ Ù…ÙƒØªØ¨Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…");
                  } else if (
                    error.message.includes("duplicate key") &&
                    error.message.includes("Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹")
                  ) {
                    console.error("Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…ÙƒØªØ¨Ø© Ø§Ø®Ø±ÙŠ");
                  } else {
                    console.error("Ø­Ø¯Ø« Ø®Ø·Ø§ Ø§Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©", error);
                  }
                  process.exit(1);
                } else {
                  console.log("ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­!");
                  process.exit(0);
                }
              });
          }
        });
      } else if (answer === "Ù„Ø§" || answer === "n") {
        console.log("ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙˆØ¯Ø¹ Ø¹Ù„Ù‰ GitHub Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
      } else {
        console.error("Ø±Ø¯ Ø¨ Ù†Ø¹Ù… Ø§Ùˆ Ù„Ø§");
      }
      rl.close();
    }
  );
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
function getLib() {
  async function install(pkgname) {
    try {
      const appDir = path.join(__dirname, "libraries", pkgname);
      console.log(`Ù…ÙƒØ§Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª: ${__dirname}`);

      await new Promise((resolve, reject) => {
        supabase
          .from("libraries")
          .select("*")
          .eq("Ø§Ù„Ø§Ø³Ù…", pkgname)
          .then(({ data, error }) => {
            if (error || !data || data.length === 0) {
              reject(`Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø© "${pkgname}"`);
            } else {
              const developer = data[0].Ø­Ø³Ø§Ø¨_Ø§Ù„Ù…Ø·ÙˆØ±;
              const repoName = data[0].Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹;
              // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù…Ù† Ø§Ù„Ø¬ÙŠØª Ù‡Ø§Ø¨
              exec(`npx degit ${developer}/${repoName} ${appDir}`, (err) => {
                if (err) {
                  if (
                    String(err).includes("destination directory is not empty")
                  ) {
                    reject(`"Ø§Ù„Ù…ÙƒØªØ¨Ø© "${pkgname}"  Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„`);
                  } else {
                    reject(`Ø­Ø¯Ø« Ø®Ø·Ø£: "${err}"`);
                  }
                } else {
                  //  Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª
                  const downloads = data[0].Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª + 1;
                  supabase
                    .from("libraries")
                    .update({ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: downloads })
                    .eq("Ø§Ù„Ø§Ø³Ù…", pkgname)
                    .then(({ error }) => {
                      if (error) {
                        console.error(
                          "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª:",
                          error
                        );
                      }
                    });
                  console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­!");
                  resolve();
                }
              });
            }
          });
      });
    } catch (error) {
      console.error(error);
    }
  }

  if (!pkgName) {
    console.error("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© ØµØ­");
  } else {
    install(pkgName);
  }
}
