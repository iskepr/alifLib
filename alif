#!/usr/bin/env node
const fs = require("fs");
const path = require("path");
const { exec } = require("child_process");
const readline = require("readline");
const { createClient } = require("@supabase/supabase-js");

const supabaseUrl = "https://gfyxjkwchsnczsmthpiw.supabase.co";
const supabaseKey =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmeXhqa3djaHNuY3pzbXRocGl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyODUyODUsImV4cCI6MjA1OTg2MTI4NX0.b40Gi7Jsk_XkJSW-W5OU8oXyQZMHLUfqVw0R09Njyj4";
const supabase = createClient(supabaseUrl, supabaseKey);

const command = process.argv[2];
const pkgName = process.argv[3];

const isPkg = typeof process.pkg !== "undefined";
let alifDir = isPkg ? path.dirname(process.execPath) : __dirname;

if (["pub", "publish", "ูุดุฑ"].includes(command)) {
  pubLib();
} else if (["get", "install", "i", "ุชุญููู"].includes(command)) {
  getLib();
} else if (["version", "v", "ุงุตุฏุงุฑ"].includes(command)) {
  console.log("0.1.0 ุงุตุฏุงุฑ ูุฏูุฑ ุงูููุชุจุงุช");
} else if (["update", "ุชุญุฏูุซ"].includes(command)) {
  if (pkgName) {
    getLib();
  } else {
    alifUpdate();
  }
}

// ุงูุชุญูู ูู git
function checkGit() {
  exec("git --version", (error, stdout, stderr) => {
    if (error || stderr) {
      console.log(" Git ุบูุฑ ูุซุจุชุ ุฌุงุฑู ุชุซุจูุชู...");

      let installCommand = "";
      if (process.platform === "win32") {
        installCommand = "winget install --id Git.Git -e --source winget"; // ูููุฏูุฒ
      } else if (process.platform === "darwin") {
        installCommand = "brew install git"; // ูุงู
      } else if (process.platform === "linux") {
        exec("cat /etc/os-release", (osError, osStdout, osStderr) => {
          if (osError || osStderr) {
            console.error("ูู ูุชู ุชุญุฏูุฏ ุงูุชูุฒูุนุฉ ุจุดูู ุตุญูุญ ูุฑุฌู ุชุซุจูุช git.");
            process.exit(1);
          }

          if (osStdout.includes("ubuntu") || osStdout.includes("debian")) {
            installCommand = "sudo apt install git";
          } else if (
            osStdout.includes("fedora") ||
            osStdout.includes("centos")
          ) {
            installCommand = "sudo dnf install git";
          }

          if (installCommand) {
            console.log(`ุณูุชู ุชุซุจูุช git ุจุงุณุชุฎุฏุงู: ${installCommand}`);
            exec(
              installCommand,
              (installError, installStdout, installStderr) => {
                if (installError || installStderr) {
                  console.error(
                    "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุซุจูุช Git:",
                    installError || installStderr
                  );
                  process.exit(1);
                }
                console.log("ุชู ุชุซุจูุช Git ุจูุฌุงุญ!");
              }
            );
          }
        });
      }

      if (installCommand) {
        console.log(`๐ ุณูุชู ุชุซุจูุช git ุจุงุณุชุฎุฏุงู: ${installCommand}`);
        exec(installCommand, (installError, installStdout, installStderr) => {
          if (installError || installStderr) {
            console.error(
              " ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุซุจูุช Git:",
              installError || installStderr
            );
            process.exit(1);
          }
          console.log(`${installStdout} ุชู ุชุซุจูุช Git ุจูุฌุงุญ!`);
        });
      }
    } else {
      // console.log(` Git ุงุตุฏุงุฑ: ${stdout}`);
    }
  });
}

// ุฏุงูุฉ ุงููุดุฑ
function pubLib() {
  checkGit();

  if (!pkgName) {
    console.error("ุงุฏุฎู ุงุณู ุงูููุชุจุฉ");
    process.exit(1);
  }

  const pkgPath = path.join(process.cwd(), "ููุชุจุฉ.ุงูู");
  if (!fs.existsSync(pkgPath)) {
    console.error('ููู "ููุชุจุฉ.ุงูู" ุบูุฑ ููุฌูุฏ ูู ุงููุฌูุฏ');
    process.exit(1);
  }

  const data = JSON.parse(fs.readFileSync(pkgPath, "utf-8"));
  const requiredFields = [
    "ุงูุงุณู",
    "ุงุณู_ุงููุณุชูุฏุน",
    "ุงูุงุตุฏุงุฑ",
    "ุงููุตู",
    "ุงูุตูุฑุฉ",
    "ุงููุทูุฑ",
    "ุญุณุงุจ_ุงููุทูุฑ",
  ];
  requiredFields.forEach((field) => {
    if (!Object.keys(data).includes(field)) {
      console.error(`ุงูุญูู "${field}" ุบูุฑ ููุฌูุฏ ูู ููู ููุชุจุฉ.ุงูู`);
      process.exit(1);
    }
  });
  if (data["ุงูุงุณู"].replaceAll(" ", "_") !== pkgName) {
    console.error(
      `ุงุณู ุงูููุชุจุฉ "${pkgName}" ูุงูู ุจุฏู ุงููุณุงูุฉ "_" ูุฌุจ ุงู ูููู ูุณุงูู ูู"ุงูุงุณู" ูู ููู "ููุชุจุฉ.ุงูู"`
    );
    process.exit(1);
  }

  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  rl.question(
    "ูู ุชู ุฅูุดุงุก ูุณุชูุฏุน ุนูู GitHub ูุฑูุน ุงููููุงุชุ (ูุนู/ูุง): ",
    (answer) => {
      if (answer === "ูุนู" || answer === "y") {
        // ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชูุฏุน ุนูู GitHub
        const repoUrl = `https://github.com/${data["ุญุณุงุจ_ุงููุทูุฑ"]}/${data["ุงุณู_ุงููุณุชูุฏุน"]}`;
        exec(`git ls-remote ${repoUrl}`, (gitError, stdout, stderr) => {
          if (gitError || stderr) {
            console.error(
              `ุชุนุฐุฑ ุงููุตูู ุฅูู ุงููุณุชูุฏุน ุนูู GitHub: ${repoUrl}. ุชุฃูุฏ ูู ุตุญุฉ ุงูุญุณุงุจ ูุงุณู ุงููุณุชูุฏุน.`
            );
            process.exit(1);
          } else {
            console.log("ุชู ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชูุฏุน ุนูู GitHub ุจูุฌุงุญ.");
            // ุฑูุน ุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            const finalData = {
              ุงูุงุณู: data["ุงูุงุณู"].replaceAll(" ", "_"),
              ุงุณู_ุงููุณุชูุฏุน: data["ุงุณู_ุงููุณุชูุฏุน"],
              ุงูุงุตุฏุงุฑ: data["ุงูุงุตุฏุงุฑ"],
              ุงููุตู: data["ุงููุตู"],
              ุงูุตูุฑุฉ: data["ุงูุตูุฑุฉ"],
              ุงููุทูุฑ: data["ุงููุทูุฑ"],
              ุญุณุงุจ_ุงููุทูุฑ: data["ุญุณุงุจ_ุงููุทูุฑ"],
              ุงููุณุชูุฏุน: `https://github.com/${data["ุญุณุงุจ_ุงููุทูุฑ"]}/${data["ุงุณู_ุงููุณุชูุฏุน"]}/`,
              ุงูุชุญูููุงุช: 0,
            };

            supabase
              .from("libraries")
              .insert(finalData)
              .then(({ error }) => {
                if (error) {
                  if (
                    error.message.includes("duplicate key") &&
                    error.message.includes("ุงูุงุณู")
                  ) {
                    console.error("ููุฌุฏ ููุชุจุฉ ุจููุณ ุงูุงุณู");
                  } else if (
                    error.message.includes("duplicate key") &&
                    error.message.includes("ุงููุณุชูุฏุน")
                  ) {
                    console.error("ุงููุณุชูุฏุน ููุฌูุฏ ูู ููุชุจุฉ ุงุฎุฑู");
                  } else {
                    console.error("ุญุฏุซ ุฎุทุง ุงุซูุงุก ุฑูุน ุงูููุชุจุฉ", error);
                  }
                  process.exit(1);
                } else {
                  console.log("ุชู ุฑูุน ุงูููุชุจุฉ ุจูุฌุงุญ!");
                  process.exit(0);
                }
              });
          }
        });
      } else if (answer === "ูุง" || answer === "n") {
        console.log("ูุฑุฌู ุฅูุดุงุก ูุณุชูุฏุน ุนูู GitHub ุฃููุงู ุซู ุฅุนุงุฏุฉ ุงููุญุงููุฉ.");
      } else {
        console.error("ุฑุฏ ุจ ูุนู ุงู ูุง");
      }
      rl.close();
    }
  );
}

// ุฏุงูุฉ ุงูุชุญููู
function getLib() {
  async function install(pkgname) {
    try {
      const appDir = path.join(alifDir, "libraries", pkgname);
      console.log(`ููุงู ุงูููุชุจุงุช: ${alifDir}`);

      await new Promise((resolve, reject) => {
        supabase
          .from("libraries")
          .select("*")
          .eq("ุงูุงุณู", pkgname)
          .then(({ data, error }) => {
            if (error || !data || data.length === 0) {
              reject(`ุญุฏุซ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุชุจุฉ "${pkgname}"`);
            } else {
              const developer = data[0].ุญุณุงุจ_ุงููุทูุฑ;
              const repoName = data[0].ุงุณู_ุงููุณุชูุฏุน;
              // ุชุญููู ุงูููุชุจุฉ ูู ุงูุฌูุช ูุงุจ
              exec(`npx degit ${developer}/${repoName} ${appDir}`, (err) => {
                if (err) {
                  if (
                    String(err).includes("destination directory is not empty")
                  ) {
                    reject(`"ุงูููุชุจุฉ "${pkgname}"  ููุฌูุฏุฉ ุจุงููุนู`);
                  } else {
                    reject(`ุญุฏุซ ุฎุทุฃ: "${err}"`);
                  }
                } else {
                  //  ุฒูุงุฏุฉ ุนุฏุฏ ุงูุชุญูููุงุช
                  const downloads = data[0].ุงูุชุญูููุงุช + 1;
                  supabase
                    .from("libraries")
                    .update({ ุงูุชุญูููุงุช: downloads })
                    .eq("ุงูุงุณู", pkgname)
                    .then(({ error }) => {
                      if (error) {
                        console.error(
                          "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุนุฏุฏ ุงูุชุญูููุงุช:",
                          error
                        );
                      }
                    });
                  console.log("ุชู ุชุญููู ุงูููุชุจุฉ ุจูุฌุงุญ!");
                  resolve();
                }
              });
            }
          });
      });
    } catch (error) {
      console.error(error);
    }
  }

  if (!pkgName) {
    console.error("ุงูุชุจ ุงุณู ุงูููุชุจุฉ ุตุญ");
  } else {
    install(pkgName);
  }
}

// ุชุญุฏูุซ ุงููุบุฉ
function alifUpdate() {
  let appName =
    process.platform === "win32"
      ? "alif.exe"
      : process.platform === "darwin"
      ? "alif.app"
      : "alif.appimage";
  let lastVer = "";
  fetch("https://api.github.com/repos/alifcommunity/Alif/releases/latest")
    .then((response) => response.json())
    .then((data) => {
      if (data && data.tag_name) {
        lastVer = data.tag_name;
        exec(
          `curl -L -o ${path.join(
            alifDir,
            appName
          )} --create-dirs -z ${path.join(
            alifDir,
            appName
          )} https://github.com/alifcommunity/Alif/releases/download/${lastVer}/${appName}`,
          (error) => {
            if (error) {
              console.error("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงููุบุฉ:", error);
              return;
            }
            console.log("ุชู ุชุญุฏูุซ ูุบุฉ ุงูู ุจูุฌุงุญ!");
          }
        );
      } else {
        console.error("ุญุฏุซ ุฎุทุง: ุงูููู ุบูุฑ ููุฌูุฏ");
      }
    })
    .catch((error) => {
      console.error("ุญุฏุซ ุฎุทุง: ุงูููู ุบูุฑ ููุฌูุฏ", error);
    });
}
